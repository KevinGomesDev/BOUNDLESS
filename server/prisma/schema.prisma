generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  kingdoms  Kingdom[]
  matches   MatchPlayer[]
}

model Kingdom {
  id             String    @id @default(uuid())
  name           String
  capitalName    String
  crestUrl       String?
  capitalImageUrl String?
  alignment      Alignment
  race           Race
  raceMetadata   String?
  locationIndex  Int
  ownerId        String
  owner          User      @relation(fields: [ownerId], references: [id])
  matchHistory   MatchPlayer[]
  createdAt      DateTime  @default(now())
}

enum Alignment {
  BOM
  MAL
  NEUTRO
}

enum Race {
  ABERRACAO
  BESTA
  CELESTIAL
  CONSTRUTO
  DRAGAO
  ELEMENTAL
  FADA
  DIABO
  GIGANTE
  HUMANOIDE
  MONSTRUOSIDADE
  GOSMA
  PLANTA
  MORTO_VIVO
  INSETO
}

model Match {
  id             String   @id @default(uuid())
  status         String   @default("WAITING")
  currentRound   Int      @default(1)
  crisisMeter    Int      @default(0)
  crisisState    String?
  players        MatchPlayer[]
  territories    Territory[]
  units          Unit[]
  structures     Structure[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model MatchPlayer {
  id             String   @id @default(uuid())
  matchId        String
  match          Match    @relation(fields: [matchId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  kingdomId      String
  kingdom        Kingdom  @relation(fields: [kingdomId], references: [id])
  playerIndex    Int      @default(0)        // 0 = Host, 1 = Guest (define cor)
  playerColor    String   @default("#ff0000") // Vermelho padrão
  isReady        Boolean  @default(false)    // Pronto na fase de preparação
  capitalTerritoryId String?                 // Território inicial/capital
  troopLevels    String   @default("{}")
  troopTemplates String   @default("{}")
  customChoices  String   @default("{}")
  resources      String   @default("{\"gold\":20,\"food\":20,\"wood\":20,\"stone\":20,\"mana\":20}")
  hasPlayedTurn  Boolean  @default(false)
  unitCount      Int      @default(0)
  buildingCount  Int      @default(0)
  units          Unit[]
  structures     Structure[]
}

model Territory {
  id             String        @id @default(uuid())
  matchId        String
  match          Match         @relation(fields: [matchId], references: [id])
  mapIndex       Int
  centerX        Float         @default(0)
  centerY        Float         @default(0)
  type           String
  terrainType    String
  polygonData    String
  size           TerritorySize @default(MEDIUM)
  areaSlots      Int           @default(10)
  usedSlots      Int           @default(0)
  ownerId        String?       // ID do MatchPlayer que controla (null = selvagem)
  isCapital      Boolean       @default(false) // É a capital de algum jogador?
  hasCrisisIntel Boolean       @default(false)
  isDisabled     Boolean       @default(false)
}

model Unit {
  id             String      @id @default(uuid())
  matchId        String
  match          Match       @relation(fields: [matchId], references: [id])
  ownerId        String?
  owner          MatchPlayer? @relation(fields: [ownerId], references: [id])
  summonerId     String?
  summoner       Unit?        @relation("Summons", fields: [summonerId], references: [id])
  summons        Unit[]       @relation("Summons")
  category       UnitCategory
  type           String
  heroClass      String?
  combat         Int
  acuity         Int
  focus          Int
  armor          Int
  vitality       Int
  currentHp      Int
  movesLeft      Int
  actionsLeft    Int
  locationIndex  Int
}

model Structure {
  id             String      @id @default(uuid())
  matchId        String
  match          Match       @relation(fields: [matchId], references: [id])
  ownerId        String?
  owner          MatchPlayer? @relation(fields: [ownerId], references: [id])
  type           String
  maxHp          Int
  currentHp      Int
  resourceType   String?
  productionRate Int
  locationIndex  Int
}

enum UnitCategory {
  TROPA
  HEROI
  REGENTE
  PRISIONEIRO
  INVOCACAO
  MONSTRO
}

enum TerritorySize {
  SMALL
  MEDIUM
  LARGE
}