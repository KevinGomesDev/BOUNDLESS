// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Mudamos de sqlite para postgresql
  url      = env("DATABASE_URL")
}

// --- Models ---

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String   // Lembre-se de hashear isso (bcrypt) antes de salvar
  createdAt DateTime @default(now())

  kingdoms  Kingdom[]
  matches   MatchPlayer[]
}

model Kingdom {
  id             String    @id @default(uuid())
  name           String
  capitalName    String
  
  // Customização Visual
  crestUrl       String?   // URL do Brasão
  capitalImageUrl String?  // URL da imagem da Capital

  // Dados Táticos
  alignment      Alignment
  race           Race
  
  // Configurações Específicas de Raça
  // Ex: Elementais salva ["Fogo", "Gelo"]. Insetos salva "Ouro".
  raceMetadata   String?   

  // Localização (Gerado pelo servidor)
  locationIndex  Int       

  // Relações
  ownerId        String
  owner          User      @relation(fields: [ownerId], references: [id])

  matchHistory   MatchPlayer[]  

  createdAt      DateTime  @default(now())
}

// --- Enums ---

enum Alignment {
  BOM
  MAL
  NEUTRO
}

enum Race {
  ABERRACAO
  BESTA
  CELESTIAL
  CONSTRUTO
  DRAGAO
  ELEMENTAL
  FADA
  DIABO
  GIGANTE
  HUMANOIDE
  MONSTRUOSIDADE
  GOSMA
  PLANTA
  MORTO_VIVO
  INSETO
}

// --- Sistema de Partidas (Matches) ---

model Match {
  id             String   @id @default(uuid())
  status         String   @default("WAITING") // WAITING, ACTIVE, FINISHED
  
  // Controle de Tempo
  currentRound   Int      @default(1)
  crisisMeter    Int      @default(0)
  
  // A Crise (Segredo e Estado)
  // Armazena: Tipo (Kaiju/Walkers...), Stats atuais, Posição, Especiais Revelados
  crisisState    String?  // JSON String

  players        MatchPlayer[]
  territories    Territory[]
  units          Unit[]
structures     Structure[] // <--- ADICIONADO (Correção do erro)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model MatchPlayer {
  id             String   @id @default(uuid())
  
  // Relações
  matchId        String
  match          Match    @relation(fields: [matchId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  kingdomId      String
  kingdom        Kingdom  @relation(fields: [kingdomId], references: [id])

  // Níveis das Tropas (Novo)
  // Ex: { "DEFENSOR": 1, "EMBOSCADOR": 2, "ATACANTE": 1, "CONJURADOR": 1 }
  troopLevels    String   @default("{}")

  // Armazena os Atributos Atuais das Categorias (O "Molde" modificado)
  // Se não tiver nada aqui, usa o padrão do sistema.
  // Ex: { "DEFENSOR": { "combat": 3, "acuity": 2, "focus": 1, "armor": 2, "vitality": 4 } }
  troopTemplates String   @default("{}") // <--- ADICIONE ISSO
  
  // Escolhas personalizadas (ex: A magia escolhida do Conjurador)
  customChoices  String   @default("{}")

  // Estado do Jogador na Partida
  resources      String   @default("{}") // JSON: { ouro: 10, mana: 5 }
  hasPlayedTurn  Boolean  @default(false)
  
  // Estatísticas para limites
  unitCount      Int      @default(0)
  buildingCount  Int      @default(0)

  units          Unit[]
  structures     Structure[] // <--- ADICIONADO (Correção do erro)
}

model Territory {
  id             String   @id @default(uuid())
  matchId        String
  match          Match    @relation(fields: [matchId], references: [id])
  
  mapIndex       Int      // ID sequencial do gerador (0, 1, 2...)
  
  // Dados Geográficos (NOVOS)
  centerX        Float    @default(0)
  centerY        Float    @default(0)
  type           String   // LAND ou WATER
  terrainType    String   // ID do TERRAIN_TYPES (ex: "FOREST")
  polygonData    String   // JSON gigante com [[x,y], [x,y]...]
  
  ownerId        String?
  hasCrisisIntel Boolean  @default(false) 
  isDisabled     Boolean  @default(false)
}

// --- ENTIDADES MÓVEIS (Unidades) ---
model Unit {
  id             String      @id @default(uuid())
  matchId        String
  match          Match       @relation(fields: [matchId], references: [id])
  
  ownerId        String?     // Null = Unidade da Crise ou Neutra
  owner          MatchPlayer? @relation(fields: [ownerId], references: [id])

// NOVA RELAÇÃO: Unidade Invocadora (Pai)
  summonerId     String?      // ID da Unidade que invocou esta (se houver)
  summoner       Unit?        @relation("Summons", fields: [summonerId], references: [id])
  summons        Unit[]       @relation("Summons") // Lista de unidades que esta aqui invocou

  // Identificação
  category       UnitCategory // TROPA, HEROI, REGENTE, PRISIONEIRO
  type           String       // O ID do "molde" (ex: "ARCHER_LV1", "WARRIOR")
  
  // Para Heróis
  heroClass      String?      // Null para Tropas normais

  // Os 5 Atributos Principais (Snapshot do momento atual)
  combat         Int
  acuity         Int
  focus          Int
  armor          Int
  vitality       Int          // Define o MaxHP
  
  // Estado Dinâmico
  currentHp      Int
  movesLeft      Int          // Quantos quadrados ainda pode andar no turno
  actionsLeft    Int          // Quantos ataques/ações pode fazer
  
  locationIndex  Int          // 0 a 99
}

// --- ENTIDADES IMÓVEIS (Estruturas) ---
model Structure {
  id             String      @id @default(uuid())
  matchId        String
  match          Match       @relation(fields: [matchId], references: [id])
  
  ownerId        String?     // Null = Neutro/Ruína
  owner          MatchPlayer? @relation(fields: [ownerId], references: [id])

  type           String       // "CITADEL", "SAWMILL", "TOWER"
  
  // Stats de Construção
  maxHp          Int
  currentHp      Int
  
  // Recurso (Se for construção de coleta)
  resourceType   String?      // "GOLD", "FOOD", "MANA"
  productionRate Int          // Quanto gera por turno

  locationIndex  Int
}

// --- NOVOS ENUMS ---
enum UnitCategory {
  TROPA
  HEROI
  REGENTE
  PRISIONEIRO
  INVOCACAO
}